<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Synced Lyrics from Apple üçé | Not Gr / blackmann</title>
    <link rel="shortcut icon" href="/static/icons/logo.png">
    <link rel="stylesheet" href="/static/main.css"/>

    
    
        <link rel="stylesheet" href="main.css"/>
    
    

    <meta name="description"
          content="Reverse engineering Apple Music synced lyrics feature for the web using Javascript"/>
    <meta name="theme-color" content="#efefef"/>

    <meta property="og:type" content="website" />
    <meta property="og:title" content="Synced Lyrics from Apple üçé" />
    <meta property="og:description" content="Reverse engineering Apple Music synced lyrics feature for the web using Javascript" />
    <meta property="og:url" content="https://degreat.co.uk/experiments/synced-lyrics"/>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SB4PQVZYY0"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag('js', new Date());

      gtag('config', 'G-SB4PQVZYY0');
    </script>
</head>
<body>
<nav class="container ph-1 nav-main">
    
        <a href="/" class="font-secondary home-link fw-medium mt-2">Go back home</a>

        <button class="font-secondary fw-medium mt-2 more d-block-mobile"
                data-target="content-navigation"
                data-content="content">More</button>
    
</nav>

<main>
    <div class="container mt-3">
    <div class="row">
        <div class="col-33 stealth content-navigation">
            <div class="ph-1">
                <h5 class="fs-1">ü™õ All experiments</h5>

                <ul>
                    
                        <li class="animate-list-entry">
                            <a href="/experiments/synced-lyrics"
                               class="d-block rounded bg-light-hover p-1 cursor-pointer">
                                    <span class="fs-1 fw-medium mt-0 text-gray">
                                        Synced Lyrics from Apple üçé
                                    </span>
                            </a>
                        </li>
                    
                </ul>
            </div>
        </div>


        <div class="col-66 content">
            <h1 class="ph-1 mb-0">Synced Lyrics from Apple üçé</h1>
            <h2 class="ph-1 subtitle mt-0 mb-2">Reverse engineering Apple Music synced lyrics feature for the web using Javascript</h2>
            <div class="ph-1">
                <main class="synced-lyrics">
  <div class="player">
    <div id="lyrics">
      <ul>
        <li data-time="16360">Pullin' out the coupe out the 'lot</li>
        <li data-time="18380">Told 'em "Fuck 12, fuck SWAT"</li>
        <li data-time="19100">Bustin' out the bells out the box</li>
        <li data-time="20620">I just hit a lick with the box</li>
        <li data-time="21720">Had to put the stick in a box, mm</li>
        <li data-time="24610">Pour up the whole damn seal, I'ma get lazy</li>
        <li data-time="28730">I got the mojo-deals, we been trappin' like the '80's</li>
        <li data-time="32330">She sell that nigga soul, gotta cashout</li>
        <li data-time="36110">Told 'em wipe a nigga nose, say slatt, slatt</li>
        <li data-time="40610">I won't never sell my soul, and I can back that</li>
        <li data-time="44360">And I really wanna know, where you at, at?</li>
        <li data-time="48600">I was setback, where the stash at?</li>
        <li data-time="50410">Cruise the city in a bulletproof Cadillac (Skrrt)</li>
        <li data-time="52420">'Cause I know these niggas after where the bag at</li>
        <li data-time="54510">Gotta move smarter, gotta move harder</li>
        <li data-time="56490">Niggas tryna get me for my water</li>
        <li data-time="58860">I live lay his ass down on my son or my daughter</li>
        <li data-time="61110">I had the Draco with me, Dwayne Carter</li>
        <li data-time="63110">'Lotta niggas out here playin', I ball 'em</li>
        <li data-time="65100">I done out my whole arm in the rim, Vince Carter</li>
        <li data-time="67610">And know I probably get a key for the quarter</li>
        <li data-time="69640">Shawty been in the scene, double C's, I bought 'em</li>
        <li data-time="71600">Got a bitch that's looking like Aaliyah, she a model</li>
        <li data-time="73850">I got the Pink Slip, all my whips is key-less</li>
        <li data-time="77520">Call them I'm 'bout to get the key to the city</li>
        <li data-time="79960">Patek like the sea</li>
        <li data-time="81710">Pullin' out the coupe out the 'lot</li>
        <li data-time="82950">Told 'em "Fuck 12, fuck SWAT"</li>
        <li data-time="84460">Bustin' out the bells out the box</li>
        <li data-time="85960">I just hit a lick with the box</li>
        <li data-time="87210">Had to put the stick in a box, mm</li>
        <li data-time="89490">Pour up the whole damn seal, I'ma get lazy</li>
        <li data-time="93330">I got the mojo-deals, we been trappin' like the '80's</li>
        <li data-time="97590">She sell that nigga soul, gotta cashout</li>
        <li data-time="101340">Told 'em wipe a nigga nose, say slatt, slatt</li>
        <li data-time="105300">I won't never sell my soul, and I can back that</li>
        <li data-time="109840">And I really wanna know, where you at, at?</li>
        <li data-time="114090">Ha-ha-ha, I been movin' them out'</li>
        <li data-time="116610">It's dealin' with me, then he got the blues in the pouch</li>
        <li data-time="119150">Took her to the forrest, put wood in her mouth</li>
        <li data-time="120630">Bitch don't wear no shoes in my house</li>
        <li data-time="122860">The private, I'm flyin' in, I never wanna fly again</li>
        <li data-time="124850">I take my chances in traffic</li>
        <li data-time="126880">She suckin' on dick no hands with it</li>
        <li data-time="128860">I just made the Rollie plane like a landing-strip</li>
        <li data-time="130870">I'm a 2020 president candidate</li>
        <li data-time="132350">I done put a hunnid bands on Zimmerman shit</li>
        <li data-time="135110">I been movin' real gangsta', so that's why she pick a cryp</li>
        <li data-time="137110">Shawty call me Crisco, 'cause I pop my shit</li>
        <li data-time="139100">Got it out the mud, there's nothin' you can tell me, yeah</li>
        <li data-time="143120">When I had the drugs, I was street-wealthy</li>
        <li data-time="147610">Pullin' out the coupe out the 'lot</li>
        <li data-time="148860">Told 'em "Fuck 12, fuck SWAT"</li>
        <li data-time="150080">Bustin' out the bells out the box</li>
        <li data-time="151560">I just hit a lick with the box</li>
        <li data-time="153100">Had to put the stick in a box, mm</li>
        <li data-time="154610">Pour up the whole damn seal, I'ma get lazy</li>
        <li data-time="159850">I got the mojo-deals, we been trappin' like the '80's</li>
        <li data-time="163860">She sell that nigga soul, gotta cashout</li>
        <li data-time="167860">Told 'em wipe a nigga nose, say slatt, slatt</li>
        <li data-time="171850">I won't never sell my soul, and I can back that</li>
        <li data-time="175860">And I really wanna know, where you at, at?</li>
      </ul>
    </div>

    <div>
      <audio controls="" src="roddy-rich_the-box.mp3" class="audio-player"></audio>
    </div>
  </div>
</main>

                <article>
                    <h1>Motivation</h1>
<p>The first time I saw synced lyrics was with the <a href="https://www.musixmatch.com">Musixmatch</a> app.
That was many years ago. Even though the title says <strong>Synced Lyrics from Apple üçé</strong>, I'm just [literally] finding out from the Musixmatch homepage that Apple uses their services.</p>
<blockquote>
<p>Read here: <a href="https://about.musixmatch.com/business/customer-stories/apple-music">https://about.musixmatch.com/business/customer-stories/apple-music</a></p>
</blockquote>
<p>But recently, I've been closer to Apple Music than with Musixmatch and I attribute the inspiration to the former.</p>
<h2>How I built this</h2>
<p>So I'm going to list the challenges I thought I would face and how I could solve them - giving myself options.</p>
<h3>Lyrics file</h3>
<p>I knew there would be a standardised lyrics file format.
And I also knew there was a higher probability of getting a lyrics file for free online.
So I searched for &quot;Roddy Rich The Box lyrics file&quot; and I got a <a href="https://www.megalobiz.com/lrc/maker/The+box.54814151">result</a>.
Then given what I was seeing, I wanted to confirm if that was a standard lyrics file.
Knowing that it was a standard lyrics file will give the assurance that every lyrics' file I find will follow that pattern.
This Wikipedia article (<a href="https://en.wikipedia.org/wiki/LRC_(file_format)">LRC (file format)</a>) gave me the assurance.</p>
<h3>Rendering the lyrics</h3>
<p>There are a couple of options to choose from on how to render the markup for the lyrics.</p>
<ol>
<li><code>Dynamic Rendering</code>: With this method, what could be done is have a list of tracks with their lyrics and as the user clicks through the tracks, you render the lyrics. This would mean, you provide a container element in your HTML markup then update the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/innerHTML"><code>innerHtml</code></a> of that element with a rendered lyrics markup whenever the track changes</li>
<li><code>Static Rendering</code>: This means the lyrics are already included on the page's markup. That is, you type each line of the lyrics into your HTML file.</li>
</ol>
<p>The difference between the two options is the same when talking about <a href="https://www.clariontech.com/blog/server-side-rendering-vs.-client-side-rendering">Server-Side Rendering vs Client-Side Rendering</a> - with client-side being the dynamic option.</p>
<p>I went with static rendering because of SEO and accessibility benefits.
But this doesn't mean I typed each line into the markup. I wrote a simple node script to parse the lyrics file and generate/insert the markup into a target HTML file.
Source here: <a href="https://github.com/blackmann/blackmann.github.io/blob/master/experiments/synced-lyrics/insert-lyrics.js"><code>insert-lyrics.js</code></a></p>
<h4>Semantic</h4>
<p>We could choose to between paragraph (<code>&lt;p/&gt;</code>) tags or list (<code>&lt;li/&gt;</code>) tags. I preferred the list tags. Makes more sense to me than a paragraph.</p>
<h3>Syncing the lyrics</h3>
<p>This was the most interesting part for me.
A couple of things to have in mind are:</p>
<ol>
<li>As the song plays, we need to move the lyric up.</li>
<li>When a user moves (seeks) the song forward or backwards, we need to show the correct/current line to that effect.</li>
<li>When a user clicks on lyrics line, we need to move (seek) the song to that line.</li>
</ol>
<blockquote>
<p>Being able to list down challenges to a problem gives you a head start on where to start tacking your problems.</p>
</blockquote>
<p>From point <strong>3</strong>, I got an <a href="https://en.wikipedia.org/wiki/Eureka_(word)"><em>eureka</em></a> to annotate each line with the time it starts.
Then, when a user clicks on that line, we move the player to that time.</p>
<p>Now since we have each line annotated with its start time, to scroll to that line we can just get the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/getBoundingClientRect"><code>bounding_rectangle</code></a><code> &gt; top</code> of that line and move by that distance.
The snippet below demonstrates what I mean</p>
<script src="https://gist.github.com/blackmann/d22ab1e2463ccd0135aa766a503dec0e.js"></script>
<p>Now for point <strong>2</strong> and <strong>3</strong>, the approach is to figure the event when time changes for an audio.
Reading through the docs for <code>&lt;audio/&gt;</code> from <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/audio">MDN</a>, I find out that, that event is <code>timeupdate</code>.</p>
<p>What this means going forward is that, whenever <code>timeupdate</code> event fires for the <code>&lt;audio /&gt;</code> - while playing or user clicks on the seekbar -  we will find the line that spans that time and scroll it into view.</p>
<script src="https://gist.github.com/blackmann/f9199ffb0422d4679b92ef9c1911ad3a.js"></script>
<h4>Finding the lyric line for a time</h4>
<p>The function to find the correct lyric line (for a <code>currentTime</code>) can follow this ad-hoc approach:</p>
<ol>
<li>let <code>found</code> (the result) be <code>undefined</code></li>
<li>iterate through the list of lyrics lines, call each line <code>line</code>
<ol>
<li>if the <code>currentTime &lt;= line.time</code>, then <code>found = line</code></li>
<li>else break (from the iteration)</li>
</ol>
</li>
</ol>
<p>As simple as that. But this method uses a <a href="https://en.wikipedia.org/wiki/Time_complexity#Linear_time">Linear Time Complexity</a>.
<em>O(n)</em> complexities aren't that terrible. But if we have the opportunity to improve our code, let's take it.</p>
<p>We can improve this line search by using <a href="https://en.wikipedia.org/wiki/Binary_search_algorithm">Binary Search</a> algorithm which is way faster than our linear search method.</p>
<p>That solution will look like this:</p>
<script src="https://gist.github.com/blackmann/1781189eb6ca2ee329940768a8379b3a.js"></script>
<h2>Done</h2>
<p>So this is the breakdown for how I worked on this. The complete source code can be found <a href="https://github.com/blackmann/blackmann.github.io/blob/master/experiments/synced-lyrics/main.js">here/Github</a>.
Only 61 lines of Javascript code.</p>

                </article>
            </div>
        </div>
    </div>
</div>
</main>

<script src="/static/js/main.js"></script>



    <script src="https://cdn.jsdelivr.net/npm/seamless-scroll-polyfill@2.1.6/lib/bundle.min.js"></script>

    <script src="main.js"></script>



<footer class="container p-1">
    <small>Generated with <a href="https://github.com/blackmann/blackmann.github.io/tree/master/tools/myjekyllripoff"><code>myjekyllripoff</code></a> written in Rust.</small>
</footer>
</body>
</html>